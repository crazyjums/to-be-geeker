# 拔掉网线后， 原本的 `TCP` 连接还存在吗？

> 拔掉网线的情况和**服务器挂了**的场景有些类似，都需要分情况讨论。
>
> 所以， 针对这个问题，要分场景来讨论：
>
> - 拔掉网线后，有数据传输；
> - 拔掉网线后，没有数据传输；

可能有的同学会说，网线都被拔掉了，那说明物理层被断开了，那在上层的传输层理应也会断开，所以原本的 `TCP` 连接就不会存在的了。就好像， 我们拨打有线电话的时候，如果某一方的电话线被拔了，那么本次通话就彻底断了。

上面这个逻辑就有问题。问题在于，错误的认为拔掉网线这个动作会影响传输层，事实上并不会影响。

实际上，`TCP` 连接在 Linux 内核中是一个名为 `struct socket` 的结构体，该结构体的内容包含 `TCP` 连接的状态等信息。当拔掉网线的时候，操作系统并不会变更该结构体的任何内容，所以 `TCP` 连接的状态也不会发生改变。

## 1 拔掉网线后，有数据传输

在客户端拔掉网线后，服务端向客户端发送的数据报文会得不到任何的响应，在等待一定时长后，服务端就会触发**超时重传**机制，重传未得到响应的数据报文。

**如果在服务端重传报文的过程中，客户端刚好把网线插回去了**，由于拔掉网线并不会改变客户端的 `TCP` 连接状态，并且还是处于 ESTABLISHED 状态，所以这时客户端是可以正常接收服务端发来的数据报文的，然后客户端就会回 ACK 响应报文。

此时，客户端和服务端的 `TCP` 连接依然存在的，就感觉什么事情都没有发生。

但是，**如果如果在服务端重传报文的过程中，客户端一直没有将网线插回去**，服务端超时重传报文的次数达到一定阈值后，内核就会判定出该 `TCP` 有问题，然后通过 Socket 接口告诉应用程序该 `TCP` 连接出问题了，于是服务端的 `TCP` 连接就会断开。

而等客户端插回网线后，如果客户端向服务端发送了数据，由于服务端已经没有与客户端相同四元祖的 `TCP` 连接了，因此服务端内核就会回复 RST 报文，客户端收到后就会释放该 `TCP` 连接。

此时，客户端和服务端的 `TCP` 连接都已经断开了。

## 2 拔掉网线后，没有数据传输

针对拔掉网线后，没有数据传输的场景，还得看是否开启了 `TCP keepalive` 机制 （`TCP` 保活机制）。

如果**没有开启** `TCP keepalive` 机制，在客户端拔掉网线后，并且双方都没有进行数据传输，那么客户端和服务端的 `TCP` 连接将会一直保持存在。

而如果**开启**了 `TCP keepalive`  机制，在客户端拔掉网线后，即使双方都没有进行数据传输，在持续一段时间后，`TCP` 就会发送探测报文：

- 如果**对端是正常工作**的。当 `TCP` 保活的探测报文发送给对端, 对端会正常响应，这样 **`TCP` 保活时间会被重置**，等待下一个 `TCP` 保活时间的到来。
- 如果**对端主机崩溃，或对端由于其他原因导致报文不可达**。当 `TCP` 保活的探测报文发送给对端后，石沉大海，没有响应，连续几次，达到保活探测次数后，**`TCP` 会报告该 `TCP` 连接已经死亡**。

所以，`TCP` 保活机制可以在双方没有数据交互的情况，通过探测报文，来确定对方的 `TCP` 连接是否存活。

## 3 总结

客户端拔掉网线后，并不会直接影响 `TCP` 连接状态。所以，拔掉网线后，`TCP` 连接是否还会存在，关键要看拔掉网线之后，有没有进行数据传输。

有数据传输的情况：

- 在客户端拔掉网线后，如果服务端发送了数据报文，那么在服务端重传次数没有达到最大值之前，客户端就插回了网线，那么双方原本的 `TCP` 连接还是能正常存在，就好像什么事情都没有发生。
- 在客户端拔掉网线后，如果服务端发送了数据报文，在客户端插回网线之前，服务端重传次数达到了最大值时，服务端就会断开 `TCP` 连接。等到客户端插回网线后，向服务端发送了数据，因为服务端已经断开了与客户端相同四元组的 `TCP` 连接，所以就会回 RST 报文，客户端收到后就会断开 `TCP` 连接。至此， 双方的 `TCP` 连接都断开了。

没有数据传输的情况：

- 如果双方都没有开启  `TCP keepalive` 机制，那么在客户端拔掉网线后，如果客户端一直不插回网线，那么客户端和服务端的 `TCP` 连接状态将会一直保持存在。
- 如果双方都开启了 `TCP keepalive` 机制，那么在客户端拔掉网线后，如果客户端一直不插回网线， `TCP keepalive` 机制会探测到对方的 `TCP` 连接没有存活，于是就会断开 `TCP` 连接。而如果在 `TCP` 探测期间，客户端插回了网线，那么双方原本的 `TCP` 连接还是能正常存在。

除了客户端拔掉网线的场景，还有客户端「宕机和杀死进程」的两种场景。

第一个场景，客户端宕机这件事跟拔掉网线是一样无法被服务端的感知的，所以如果在没有数据传输，并且没有开启  `TCP keepalive` 机制时，，**服务端的 `TCP` 连接将会一直处于 ESTABLISHED 连接状态**，直到服务端重启进程。

所以，我们可以得知一个点。在没有使用 `TCP` 保活机制，且双方不传输数据的情况下，一方的 `TCP` 连接处在 ESTABLISHED 状态时，并不代表另一方的 `TCP` 连接还一定是正常的。

第二个场景，杀死客户端的进程后，客户端的内核就会向服务端发送 FIN 报文，**与客户端进行四次挥手**。

所以，即使没有开启  `TCP keepalive` ，且双方也没有数据交互的情况下，如果其中一方的进程发生了崩溃，这个过程操作系统是可以感知的到的，于是就会发送 FIN 报文给对方，然后与对方进行 `TCP` 四次挥手。